<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>å°ç£å¤©æ°£èˆ‡æ—…éŠåœ°åœ– (ä¸‰æ¬„ä½ˆå±€)</title>

    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, "Noto Sans TC", sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #f8f8f8;
            min-height: 100vh;
        }

        h1 {
            margin-top: 20px;
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }

        /* --- Layout: ä¸‰æ¬„ä½ˆå±€è¨­å®š --- */
        .container {
            display: flex; 
            flex-wrap: wrap; 
            justify-content: center;
            gap: 15px; 
            width: 100%;
            padding: 20px;
            box-sizing: border-box;
            max-width: 1500px; 
        }

        /* --- Map (å±…ä¸­ï¼Œä½”æ“šä¸»è¦å¯¬åº¦) --- */
        #mapBox {
            flex-basis: 50%; 
            max-width: 700px;
            min-width: 300px;
            flex-grow: 1;
        }

        #taiwanMap {
            width: 100%;
            height: auto;
        }

        /* --- Panel å®¹å™¨é€šç”¨æ¨£å¼ (å¤©æ°£å’Œè§€å…‰) --- */
        #weatherPanel, #tourismPanel {
            flex-basis: 23%; 
            min-width: 300px; 
            flex-grow: 1;
            
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #fff;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
            overflow: hidden;
            display: flex;
            flex-direction: column; 
        }
        
        /* --- æ¨™é¡Œé€šç”¨æ¨£å¼ --- */
        .section-title {
            padding: 15px 20px;
            margin: 0;
            font-size: 20px;
            font-weight: bold;
            border-bottom: 1px solid #e0e0e0;
        }

        /* --- å¤©æ°£æ¨™é¡Œ (å·¦å´) --- */
        #cityTitle {
            color: #007bff;
            background-color: #f0f8ff; 
        }

        /* --- è§€å…‰æ¨™é¡Œ (å³å´) --- */
        #tourismPanel .section-title {
            color: #007bff;
            background-color: #e9f7ff; 
        }

        /* --- å…§å®¹å€åŸŸå…§é‚Šè· --- */
        .panel-content {
            padding: 15px 20px;
            flex-grow: 1; 
        }
        
        /* --- Hover & Selection (ä¿æŒä¸è®Š) --- */
        .city-area:hover {
            fill: #007bff !important;
            cursor: pointer;
            opacity: 0.8;
            transition: fill 0.3s; 
        }

        /* --- å¡ç‰‡æ¨£å¼ (å¤©æ°£ & æ™¯é») (ä¿æŒä¸è®Š) --- */
        #weatherResult, #touristSpotsList {
            display: flex;
            flex-direction: column;
            gap: 10px;
            min-height: 80px; 
            padding: 0; 
        }
        
        .forecast-card, .spot-card {
            padding: 12px;
            border: 1px solid #dcdcdc;
            border-radius: 6px;
            background-color: #ffffff;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .forecast-card:hover, .spot-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
        }

        .spot-card h4 { color: #0056b3; } 
        .forecast-card p, .spot-card p { font-size: 14px; color: #666; }
        .temp-range { color: #d9534f; font-weight: bold; }
        
        /* ================================================= */
        /* --- ç©¿æ­å»ºè­°å€å¡Šæ¨£å¼ --- */
        /* ================================================= */
        .clothing-advice {
            margin-top: 10px;
            padding-top: 5px; 
            border-top: 1px dashed #eee; 
            color: #1e7e34; 
            font-weight: bold;
            display: flex; 
            align-items: center; 
            gap: 8px; 
        }
        
        /* ç©¿æ­åœ–ç¤ºæ¨£å¼ */
        .clothing-icon {
            width: 30px;
            height: 30px;
            object-fit: cover;
            border-radius: 3px;
            flex-shrink: 0; 
        }

        /* â­ æ–°å¢ï¼šç”¨æ–¼åŒ…è£¹ 30x30 åœ–ç¤ºçš„å®¹å™¨ï¼Œä½¿å…¶å¯é»æ“Š */
        .icon-wrapper {
            cursor: pointer;
            display: inline-block;
            line-height: 0; /* æ¶ˆé™¤ baseline å½±éŸ¿ */
            transition: opacity 0.2s;
        }

        .icon-wrapper:hover {
            opacity: 0.8;
        }
        
        /* ================================================= */
        /* --- åœ–ç‰‡æ”¾å¤§ Modal æ¨£å¼ (é‡æ–°å¼•å…¥) --- */
        /* ================================================= */
        #imageModal {
            display: none; 
            position: fixed;
            z-index: 1000; 
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.9); 
            align-items: center;
            justify-content: center;
        }

        #modalContent {
            margin: auto;
            display: block;
            width: 80%;
            max-width: 900px;
            max-height: 90vh;
            object-fit: contain; 
        }

        .close-btn {
            position: absolute;
            top: 15px;
            right: 35px;
            color: #f1f1f1;
            font-size: 40px;
            font-weight: bold;
            transition: 0.3s;
            cursor: pointer;
        }

        /* ------------------------------------------- */
        /* --- RWD Media Query (åˆ‡æ›åˆ°å †ç–Šä½ˆå±€) --- */
        /* ------------------------------------------- */
        @media (max-width: 1200px) {
            .container {
                flex-direction: column; 
                align-items: center;
                gap: 25px; 
            }

            #mapBox, #weatherPanel, #tourismPanel {
                max-width:500px; 
                width: 100%;
                flex-basis: auto; 
            }
        }
        
        @media (max-width: 900px) {
            .section-title { padding: 12px 15px; font-size: 18px; }
            .panel-content { padding: 12px 15px; }
        }
    </style>
</head>
<body>

<h1>å°ç£å¤©æ°£èˆ‡æ—…éŠåœ°åœ–</h1>

<div class="container">
    
    <div id="weatherPanel">
        <h2 id="cityTitle" class="section-title">å¤©æ°£è³‡è¨Š</h2>
        <div class="panel-content">
            <div id="weatherResult">è«‹é»é¸åœ°åœ–ä¸Šçš„ç¸£å¸‚</div>
        </div>
    </div>

    <div id="mapBox">
        <object id="taiwanMap" type="image/svg+xml" data="country.svg"></object> 
    </div>

    <div id="tourismPanel">
        <h3 class="section-title">è§€å…‰æ™¯é»</h3>
        <div class="panel-content">
            <div id="touristSpotsList"></div>
        </div>
    </div>
</div>

<div id="imageModal" onclick="closeModal()">
    <span class="close-btn">&times;</span> 
    <img id="modalContent" onclick="event.stopPropagation()">
</div>
<script>
// â­ å®šç¾©é¡è‰²å¸¸é‡ (ä¿æŒä¸è®Š)
const UNSELECTED_COLOR = '#CCCCCC';
const SELECTED_COLOR = '#e83e8c';
const LOADING_COLOR = '#ffc107';

// â­ è«‹å°‡æ­¤è™•æ›¿æ›ç‚ºæ‚¨è‡ªå·±çš„äº¤é€šéƒ¨è§€å…‰ç½² API Keyï¼
const TOURISM_API_KEY = "YOUR_TOURISM_API_KEY_HERE"; 

/* ================================================= */
/* --- åœ–ç‰‡æ”¾å¤§/ç¸®å°å‡½æ•¸ (é‡æ–°åŠ å…¥) --- */
/* ================================================= */
const modal = document.getElementById("imageModal");
const modalImg = document.getElementById("modalContent");

/**
 * é¡¯ç¤ºåœ–ç‰‡æ”¾å¤§è¦–çª—
 * @param {string} imgSrc - åœ–ç‰‡çš„ URL
 */
function openModal(imgSrc) {
    modal.style.display = "flex"; 
    modalImg.src = imgSrc; 
}

/**
 * éš±è—åœ–ç‰‡æ”¾å¤§è¦–çª—
 */
function closeModal() {
    modal.style.display = "none";
}

// ç¢ºä¿åªæœ‰ modal å…ƒç´ å­˜åœ¨æ™‚æ‰å˜—è©¦æ·»åŠ é»æ“Šäº‹ä»¶
if (document.querySelector(".close-btn")) {
    document.querySelector(".close-btn").onclick = closeModal;
}


/**
 * è¼‰å…¥è§€å…‰æ™¯é»è³‡æ–™ä¸¦é¡¯ç¤º (ç°¡åŒ–æ™¯é»åœ–ç‰‡è™•ç†)
 * @param {string} city - åŸå¸‚åç¨±
 */
function loadTouristSpots(city) {
    const spotsList = document.getElementById("touristSpotsList");
    spotsList.innerHTML = '<p style="text-align:center; color:#888; padding: 10px 0;">æ™¯é»è³‡æ–™è¼‰å…¥ä¸­...</p>';

    if (!TOURISM_API_KEY || TOURISM_API_KEY === "YOUR_TOURISM_API_KEY_HERE") {
        spotsList.innerHTML = '<p style="color:red; text-align:center; padding: 10px 0;">è«‹è¨­å®šè§€å…‰ API Keyã€‚</p>';
        console.warn("è§€å…‰ API Key æœªè¨­å®šã€‚");
        return;
    }

    const encodedCity = encodeURIComponent(city.replace('è‡º', 'å°')); 
    const url = `https://tdx.transportdata.tw/api/basic/v2/Tourism/ScenicSpot?$filter=City%20eq%20'${encodedCity}'&$top=5&$format=JSON`;
    
    fetch(url, {
        headers: {
            'Authorization': `Bearer ${TOURISM_API_KEY}`
        }
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(err => { throw new Error(`TDX API éŒ¯èª¤: ${response.status} - ${err.message || response.statusText}`); });
        }
        return response.json();
    })
    .then(data => {
        spotsList.innerHTML = '';
        const scenicSpots = data.ScenicSpots;

        if (scenicSpots && scenicSpots.length > 0) {
            scenicSpots.forEach(spot => {
                const card = document.createElement('div');
                card.classList.add('spot-card');
                
                const name = spot.ScenicSpotName || 'æœªå‘½åæ™¯é»';
                const address = spot.Address || 'ç„¡åœ°å€è³‡è¨Š';
                const imageUrl = spot.Picture && spot.Picture.PictureUrl1 ? spot.Picture.PictureUrl1 : '';

                card.innerHTML = `
                    <h4>ğŸ“ ${name}</h4>
                    ${imageUrl ? `<img src="${imageUrl}" alt="${name}" style="width:100%; height:auto; border-radius:4px; margin-bottom:8px;">` : ''}
                    <p>${address}</p>
                `;
                spotsList.appendChild(card);
            });
        } else {
            spotsList.innerHTML = '<p style="text-align:center; color:#888; padding: 10px 0;">æŸ¥ç„¡ç›¸é—œè§€å…‰æ™¯é»è³‡æ–™ã€‚</p>';
        }
    })
    .catch(error => {
        console.error('è¼‰å…¥è§€å…‰æ™¯é»ç™¼ç”ŸéŒ¯èª¤:', error);
        spotsList.innerHTML = `<p style="color:red; text-align:center; padding: 10px 0;">æ™¯é»è¼‰å…¥å¤±æ•—: ${error.message}</p>`;
    });
}


/**
 * æ ¹æ“šæº«åº¦ã€é™é›¨ç‡å’Œèˆ’é©åº¦æè¿°æä¾›ç©¿è¡£å»ºè­° (ä¿æŒä¸è®Š)
 */
function getClothingAdvice(minTemp, maxTemp, rain, comfort) {
    const avgTemp = (minTemp + maxTemp) / 2;
    let advice = "";

    if (avgTemp >= 28) {
        advice = "é…·ç†±ï¼å»ºè­°ç©¿è‘—çŸ­è¢–ã€çŸ­è¤²ã€è£™å­ï¼Œä¸¦å‹™å¿…åšå¥½é˜²æ›¬åŠæ°´åˆ†è£œå……ã€‚";
    } else if (avgTemp >= 23) {
        advice = "æº«æš–èˆ’é©ï¼Œå»ºè­°ç©¿è‘— T æ¤ã€è–„é•·è¢–æˆ–æ´‹è£ï¼Œå‚™ä¸€ä»¶è–„å¤–å¥—å³å¯ã€‚";
    } else if (avgTemp >= 18) {
        advice = "ç¨æœ‰æ¶¼æ„ï¼Œå»ºè­°æ¡æ´‹è”¥å¼ç©¿æ³•ï¼Œç©¿è‘—é•·è¢–ã€è¡›è¡£æˆ–è–„æ¯›è¡£ï¼Œæ­é…å¤–å¥—ã€‚";
    } else if (avgTemp >= 13) {
        advice = "è¼ƒç‚ºå¯’å†·ï¼Œå»ºè­°ç©¿è‘—åšé•·è¢–ã€æ¯›è¡£æˆ–å¤¾å…‹ï¼Œä¸¦æ­é…é•·è¤²ã€‚";
    } else { // avgTemp <= 12
        advice = "å¯’å†·ï¼è«‹å‹™å¿…ç©¿è‘—åšå¤–å¥—ã€ç¾½çµ¨æœã€ç™¼ç†±è¡£å’Œåœå·¾ï¼ŒåŠ å¼·ä¿æš–ã€‚";
    }

    // æ ¹æ“šé™é›¨èª¿æ•´å»ºè­°
    if (rain >= 50) {
        advice += " âš ï¸ä»Šæ—¥é™é›¨æ©Ÿç‡é«˜ï¼Œå‹™å¿…æ”œå¸¶é›¨å…·ä¸¦è€ƒæ…®ç©¿è‘—é˜²æ°´å¤–å¥—ã€‚";
    } else if (rain >= 30) {
        advice += " â˜”ï¸æœ‰å±€éƒ¨é™é›¨æ©Ÿæœƒï¼Œå»ºè­°æ”œå¸¶é›¨å…·å‚™ç”¨ã€‚";
    }

    // æ ¹æ“šé«”æ„Ÿæè¿°å¾®èª¿
    if (comfort.includes('æ½®æ¿•') || comfort.includes('æ‚¶ç†±')) {
        advice += " ğŸ’§é«”æ„Ÿåæ½®æ¿•æ‚¶ç†±ï¼Œå»ºè­°é¸æ“‡é€æ°£å¸æ±—æè³ªçš„è¡£ç‰©ã€‚";
    } else if (comfort.includes('æ¶¼çˆ½') || comfort.includes('èˆ’é©')) {
        advice += " â˜€ï¸é«”æ„Ÿèˆ’é©ï¼Œè¼•é¬†äº«å—å¥½å¤©æ°£ï¼";
    }

    return advice;
}

 // â­ å…¨åŸŸå¿«å–è®Šæ•¸ï¼šåªå„²å­˜ä¸€æ¬¡æ‰€æœ‰åŸå¸‚çš„å¤©æ°£è³‡æ–™
let weatherCache = null; 
const WEATHER_API_URL = "https://jringyoutask2.zeabur.app/api/weather/getAllCityWeather";


/**
 * æ ¹æ“šå¹³å‡æº«åº¦é¸æ“‡å°æ‡‰çš„ç©¿æ­åœ–ç¤º URL (è¿”å›æ ¹ç›®éŒ„è·¯å¾‘)
 * @param {number} avgTemp - å¹³å‡æº«åº¦ (C)
 * @returns {string} ç©¿æ­åœ–ç¤ºçš„ç›¸å° URL
 */
function getClothingIcon(avgTemp) {
    // â­ æ ¹æ“šæ‚¨çš„è¦æ±‚ï¼Œé€™è£¡è¿”å›çš„æ˜¯ç›¸å°æ ¹ç›®éŒ„çš„è·¯å¾‘
    if (avgTemp >= 28) {
        return 'Clother_01.png'; 
    } else if (avgTemp >= 23) {
        return 'Clother_02.png'; 
    } else if (avgTemp >= 18) {
        return 'Clother_03.png'; 
    } else if (avgTemp >= 13) {
        return 'Clother_04.png'; 
    } else { 
        return 'Clother_05.png'; 
    }
}

/**
 * â­ æ ¹æ“š avgTemp å–å¾—ä¸¦ç”Ÿæˆ HTML åœ–åƒæ¨™ç±¤ (åŒ…å«é»æ“Šæ”¾å¤§åŠŸèƒ½)
 * @param {number} avgTemp - å¹³å‡æº«åº¦ (C)
 * @returns {string} åŒ…å« 30x30 åœ–ç‰‡å’Œé»æ“Šäº‹ä»¶çš„ HTML å­—ç¬¦ä¸²
 */
function getClothingImg(avgTemp) {
    const iconUrl = getClothingIcon(avgTemp); // å‘¼å« getClothingIcon å–å¾—ç›¸å°è·¯å¾‘
    // å°‡å¯é»æ“Šçš„ div åƒ…åŒ…è£¹åœ–ç‰‡ï¼Œä¸¦ç¶å®š openModal
    return `
        <div class="icon-wrapper" onclick="openModal('${iconUrl}')">
            <img src="${iconUrl}" class="clothing-icon" alt="ç©¿æ­åœ–ç¤º">
        </div>
    `;
}


/**
 * â­ è¼‰å…¥å¤©æ°£è³‡æ–™ (ä½¿ç”¨ getClothingImg å‡½æ•¸) â­
 * @param {string} city - åŸå¸‚åç¨±
 * @param {SVGElement} svgElement - è¢«é»æ“Šçš„ SVG å…ƒç´ 
 */
function loadWeather(city, svgElement) {
    const resultContainer = document.getElementById("weatherResult");
    const spotsList = document.getElementById("touristSpotsList");
    const cityTitle = document.getElementById("cityTitle");
    
    cityTitle.innerText = `ã€${city}ã€‘è®€å–ä¸­...`;
    resultContainer.innerHTML = '<p style="text-align:center; color:#888; padding: 10px 0;">å¤©æ°£è³‡æ–™è¼‰å…¥ä¸­...</p>';
    spotsList.innerHTML = '<p style="text-align:center; color:#888; padding: 10px 0;">æ™¯é»è³‡æ–™è¼‰å…¥ä¸­...</p>';
    
    if (svgElement) {
        svgElement.setAttribute('fill', LOADING_COLOR);
    }

    const dataPromise = weatherCache 
        ? Promise.resolve({ data: weatherCache }) 
        : fetch(WEATHER_API_URL).then(response => { 
            if (!response.ok) {
                throw new Error(`HTTP éŒ¯èª¤: ${response.status}`);
            }
            return response.json();
        });


    dataPromise
        .then(responseData => {
            if (!weatherCache) {
                weatherCache = responseData.data; 
            }
            const allCityData = weatherCache; 

            if (svgElement) {
                svgElement.setAttribute('fill', SELECTED_COLOR);
            }

            const found = allCityData.find(item => item.city && item.city.includes(city));

            if (found) {
                cityTitle.innerText = `${found.city}ï¼šæœªä¾†é å ±`; 
                resultContainer.innerHTML = ''; 

                found.forecasts.forEach(el => {
                    const card = document.createElement('div');
                    card.classList.add('forecast-card');
                    
                    const startTimeText = el.startTime.substring(5, 16).replace('-', '/');
                    const endTimeText = el.endTime.substring(11, 16);
                    
                    const minTemp = parseFloat(el.minTemp);
                    const maxTemp = parseFloat(el.maxTemp);
                    const rain = parseFloat(el.rain);
                    
                    const avgTemp = (minTemp + maxTemp) / 2; // è¨ˆç®—å¹³å‡æº«åº¦
                    
                    const clothingAdvice = getClothingAdvice(minTemp, maxTemp, rain, el.comfort);
                    
                    // â­ ä½¿ç”¨ getClothingImg å‡½æ•¸ç”Ÿæˆå¸¶æœ‰å¯é»æ“Šåœ–ç¤ºçš„ HTML
                    const clothingImgHtml = getClothingImg(avgTemp);
                    
                    card.innerHTML = `
                        <h4>ğŸ“… ${startTimeText} ~ ${endTimeText}</h4>
                        <p>â˜ï¸ å¤©æ°£ï¼š${el.weather}</p>
                        <p class="temp-range">
                            ğŸŒ¡ æº«åº¦ï¼š${el.minTemp} ~ ${el.maxTemp}
                        </p>
                        <p>ğŸ‘¤ é«”æ„Ÿï¼š${el.comfort}</p>
                        <p>ğŸ’§ é™é›¨ç‡ï¼š${el.rain}</p>
                        <div class="clothing-advice">
                            ${clothingImgHtml}
                            <span>ğŸ§¥ å»ºè­°ç©¿æ­ï¼š${clothingAdvice}</span>
                        </div>
                    `;
                    resultContainer.appendChild(card);
                });
                
                loadTouristSpots(found.city);

            } else {
                cityTitle.innerText = "å¤©æ°£è³‡è¨Š";
                resultContainer.innerHTML = `<p style="color:red; text-align:center; padding: 10px 0;">æŸ¥ç„¡ ${city} çš„å¤©æ°£è³‡æ–™ã€‚</p>`;
                spotsList.innerHTML = '<p style="text-align:center; color:#888; padding: 10px 0;">è«‹é»é¸åœ°åœ–ä¸Šçš„ç¸£å¸‚</p>';
            }
        })
        .catch(error => {
            if (svgElement) {
                svgElement.setAttribute('fill', SELECTED_COLOR);
            }
            cityTitle.innerText = "å¤©æ°£è³‡è¨Š (è¼‰å…¥å¤±æ•—)";
            resultContainer.innerHTML = `<p style="color:red; text-align:center; padding: 10px 0;">å¤©æ°£è³‡æ–™è¼‰å…¥å¤±æ•—ï¼ (${error.message})</p>`;
            spotsList.innerHTML = '<p style="text-align:center; color:#888; padding: 10px 0;">æ™¯é»è¼‰å…¥å¤±æ•—</p>';
            console.error('API è«‹æ±‚æˆ–è™•ç†ç™¼ç”ŸéŒ¯èª¤:', error);
        });
}

/* ===========================
    å•Ÿå‹• SVG é»æ“Šäº‹ä»¶ (ä¿æŒä¸è®Š)
============================= */
document.getElementById("taiwanMap").addEventListener("load", () => {
    const svgObject = document.getElementById("taiwanMap");
    const svg = svgObject.contentDocument;

    const areas = svg.querySelectorAll("[data-city]");
    
    let selectedArea = null; 

    areas.forEach(area => {
        area.classList.add("city-area");
        
        area.setAttribute('fill', UNSELECTED_COLOR);
        area.style.transition = 'fill 0.3s ease'; 
        
        area.addEventListener("click", () => {
            
            if (selectedArea && selectedArea !== area) {
                selectedArea.setAttribute('fill', UNSELECTED_COLOR);
            }

            area.setAttribute('fill', SELECTED_COLOR);
            selectedArea = area;
            
            const cityName = area.getAttribute("data-city");
            loadWeather(cityName, area); 
        });
    });
});
</script>

</body>
</html>